<!DOCTYPE html>
<html>
<head>
    <title>Rastreamento em Tempo Real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 800px;
            width: 100%;
        }
        .vehicle-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        .vehicle-list {
            margin-top: 10px;
        }
        .vehicle-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status.online {
            background-color: #4CAF50;
        }
        .status.offline {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="vehicle-info">
        <h3>Veículos Online: <span id="vehicleCount">0</span></h3>
        <div id="vehicleList" class="vehicle-list"></div>
    </div>
    <div id="debug" class="debug-panel"></div>

    <script>
        // Inicializa o mapa
        var map = L.map('map').setView([-23.5505, -46.6333], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // Armazena os marcadores dos veículos
        var vehicles = {};
        var vehicleCount = 0;

        function updateVehicleCount() {
            document.getElementById('vehicleCount').textContent = vehicleCount;
        }

        function updateVehicleList() {
            const list = document.getElementById('vehicleList');
            list.innerHTML = '';
            Object.values(vehicles).forEach(vehicle => {
                const div = document.createElement('div');
                div.className = 'vehicle-item';
                div.innerHTML = `
                    <strong>${vehicle.data.idVeiculo}</strong><br>
                    Lat: ${vehicle.data.latitude.toFixed(6)}<br>
                    Lon: ${vehicle.data.longitude.toFixed(6)}<br>
                    Vel: ${vehicle.data.velocidade.toFixed(1)} km/h<br>
                    Última atualização: ${new Date(vehicle.data.dataHora).toLocaleTimeString()}
                `;
                list.appendChild(div);
            });
        }

        function log(message) {
            console.log(message);
            const debug = document.getElementById('debug');
            debug.innerHTML = new Date().toLocaleTimeString() + ': ' + message + '<br>' + debug.innerHTML;
            if (debug.childNodes.length > 50) {
                debug.removeChild(debug.lastChild);
            }
        }

        // Conecta ao WebSocket
        var socket = new SockJS('/ws');
        var stompClient = Stomp.over(socket);
        stompClient.debug = function(str) {
            log(str);
        };

        // Configuração do Stomp
        stompClient.reconnect_delay = 5000;
        
        stompClient.connect({}, 
            function(frame) {
                log('Conectado ao WebSocket');
                stompClient.subscribe('/topic/localizacoes', function(message) {
                    try {
                        log('Mensagem recebida: ' + message.body);
                        const data = JSON.parse(message.body);
                        updateVehicleLocation(data);
                    } catch (error) {
                        log('Erro ao processar mensagem: ' + error);
                    }
                });
            },
            function(error) {
                log('Erro na conexão WebSocket: ' + error);
                setTimeout(function() {
                    location.reload();
                }, 5000);
            }
        );

        function updateVehicleLocation(data) {
            log(`Atualizando veículo ${data.idVeiculo} - Lat: ${data.latitude}, Lon: ${data.longitude}`);

            // Remove marcador antigo se existir
            if (vehicles[data.idVeiculo]) {
                map.removeLayer(vehicles[data.idVeiculo].marker);
            } else {
                vehicleCount++;
                updateVehicleCount();
            }

            // Cria novo marcador
            const marker = L.marker([data.latitude, data.longitude])
                .bindPopup(`
                    <strong>${data.idVeiculo}</strong><br>
                    Latitude: ${data.latitude.toFixed(6)}<br>
                    Longitude: ${data.longitude.toFixed(6)}<br>
                    Velocidade: ${data.velocidade.toFixed(1)} km/h<br>
                    Última atualização: ${new Date(data.dataHora).toLocaleTimeString()}
                `);
            
            vehicles[data.idVeiculo] = {
                marker: marker,
                data: data
            };
            
            marker.addTo(map);
            updateVehicleList();
        }

        // Limpa conexão quando a página for fechada
        window.addEventListener('beforeunload', function() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
        });
    </script>
</body>
</html> 